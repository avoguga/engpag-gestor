<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerenciador - Eng Pag</title>
  <!-- Font Awesome para ícones -->
  <script src="https://kit.fontawesome.com/2bd16d993e.js" crossorigin="anonymous"></script>
  <!-- Google Fonts para uma fonte mais agradável -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Reset básico para consistência */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f9fafb;
      color: #333;
      min-height: 100vh;
      display: flex;
      transition: all 0.3s ease;
    }

    /* Tela de Login */
    .login-container {
      display: none; /* Inicialmente escondida */
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100vh;
      background-color: rgba(249, 250, 251, 0.95);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }

    .login-box {
      background-color: #ffffff;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      width: 350px;
      text-align: center;
      animation: fadeIn 0.5s ease-in-out;
    }

    .login-box h2 {
      margin-bottom: 25px;
      color: #d9534f; /* Tom de vermelho mais suave */
      font-size: 1.8em;
    }

    .login-box input[type="text"],
    .login-box input[type="password"] {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 20px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .login-box input[type="text"]:focus,
    .login-box input[type="password"]:focus {
      border-color: #d9534f;
      outline: none;
      box-shadow: 0 0 5px rgba(217, 83, 79, 0.5);
    }

    .login-box button {
      background-color: #d9534f;
      color: white;
      padding: 14px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease, transform 0.3s ease;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
    }

    .login-box button:hover {
      background-color: rgba(201, 48, 44, 0.4); /* Ajustado para maior opacidade */
      transform: translateY(-3px);
    }

    .login-box .message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 6px;
      font-size: 15px;
      animation: fadeIn 0.5s ease-in-out;
    }

    .login-box .success {
      background-color: #d4edda;
      color: #155724;
    }

    .login-box .error {
      background-color: #f8d7da;
      color: #721c24;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background-color: #F6D7D7; /* Nova cor da sidebar */
      color: #333;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      position: fixed;
      height: 100vh;
      transition: width 0.3s ease, background-color 0.3s ease;
      overflow: hidden;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      z-index: 999;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    /* Logo na Sidebar */
    .sidebar .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 25px auto; /* Centraliza horizontalmente e adiciona margem inferior */
      padding: 5px; 
      border-radius: 8px;
      max-width: 180px; /* Limita a largura máxima */
      transition: max-width 0.3s ease;
    }

    .sidebar.collapsed .logo {
      max-width: 50px; /* Reduz a largura quando colapsada */
    }

    .sidebar .logo img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      transition: transform 0.3s ease;
    }

    .sidebar.collapsed .logo img {
      transform: scale(0.7); /* Reduz a logo quando colapsada */
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #ecf0f1;
      font-size: 1.5em;
      display: none; /* Removido o título */
    }

    .sidebar a {
      padding: 14px 20px;
      text-decoration: none;
      color: #333;
      background-color: transparent;
      display: flex;
      align-items: center;
      transition: background-color 0.3s, padding 0.3s, box-shadow 0.3s, color 0.3s;
      white-space: nowrap;
      position: relative;
      border-left: 5px solid transparent;
      border-radius: 8px;
      margin: 6px 10px;
      font-size: 16px;
      font-weight: 500;
    }

    .sidebar a i {
      margin-right: 12px; /* Espaço entre ícone e texto */
      font-size: 1.5em; /* Aumentado para melhor visibilidade */
      color: #d9534f; /* Ícones com tom de vermelho */
      transition: color 0.3s;
    }

    .sidebar.collapsed a i {
      margin-right: 0; /* Remover margem quando colapsado */
      font-size: 1.8em; /* Aumentar ainda mais quando colapsado */
      color: #ffffff; /* Cor branca para contraste */
    }

    .sidebar a span {
      transition: opacity 0.3s ease;
    }

    .sidebar.collapsed a span {
      opacity: 0;
      visibility: hidden;
      width: 0;
      display: none;
    }

    .sidebar a:hover {
      background-color: #f8c6c6; /* Fundo mais claro no hover */
      padding-left: 25px;
      border-left: 5px solid #d9534f;
      box-shadow: inset 5px 0 0 #d9534f;
      color: #d9534f; /* Texto no hover muda para vermelho */
    }

    .sidebar a.active {
      background-color: #d9534f;
      padding-left: 25px;
      font-weight: bold;
      border-left: 5px solid #c9302c;
      box-shadow: inset 5px 0 0 #c9302c;
      color: white;
    }

    .sidebar.collapsed a.active {
      background-color: #d9534f;
      border-left: 5px solid #c9302c;
      box-shadow: inset 5px 0 0 #c9302c;
      color: white;
    }

    .sidebar.collapsed a.active i {
      color: white;
    }

    .sidebar.collapsed a.active span {
      display: none;
    }

    .sidebar.collapsed a:hover {
      background-color: #f8c6c6;
      padding-left: 10px;
      border-left: 5px solid #d9534f;
      box-shadow: inset 5px 0 0 #d9534f;
      color: #d9534f;
    }

    .sidebar.collapsed a:hover i {
      color: #d9534f;
    }

    .sidebar.collapsed a:hover span {
      opacity: 0;
      visibility: hidden;
      width: 0;
      display: none;
    }

    .sidebar .submenu {
      display: none;
      flex-direction: column;
      margin-left: 10px;
    }

    .sidebar .submenu a {
      padding: 10px 20px;
      background-color: #ffe6e6;
      border-left: 3px solid transparent;
      transition: background-color 0.3s, padding-left 0.3s, border-left 0.3s, color 0.3s;
      margin: 5px 0;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 400;
      color: #333;
    }

    .sidebar .submenu a i {
      margin-right: 12px; /* Espaço entre ícone e texto nas submenus */
      color: #d9534f;
      transition: color 0.3s;
    }

    .sidebar .submenu a:hover {
      background-color: #f8c6c6;
      padding-left: 30px;
      border-left: 3px solid #d9534f;
      color: #d9534f;
    }

    .sidebar .submenu a.active-sub {
      background-color: #d9534f;
      padding-left: 30px;
      font-weight: bold;
      border-left: 3px solid #a71d2a;
      color: white;
    }

    .sidebar .submenu a.active-sub i {
      color: white;
    }

    /* Botão de toggle da sidebar */
    .toggle-btn {
      background: none;
      border: none;
      color: #333;
      font-size: 1.5em;
      cursor: pointer;
      padding: 10px 20px;
      text-align: right;
      transition: background-color 0.3s, color 0.3s;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .toggle-btn:hover {
      background-color: #ffe6e6;
      border-radius: 8px;
      color: #d9534f;
    }

    .sidebar.collapsed .toggle-btn {
      justify-content: center;
      padding: 10px;
    }

    .sidebar.collapsed .toggle-btn:hover {
      background-color: #ffe6e6;
      border-radius: 50%;
      color: #d9534f;
    }

    /* Tooltip Personalizado */
    .sidebar a.collapsed-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      background-color: #333;
      color: #fff;
      padding: 6px 8px;
      border-radius: 4px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      margin-left: 8px;
      font-size: 14px;
      pointer-events: none;
      z-index: 100;
    }

    .sidebar.collapsed a:hover::after {
      opacity: 1;
      visibility: visible;
    }

    .sidebar a.collapsed-tooltip::before {
      content: '';
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      border-width: 6px;
      border-style: solid;
      border-color: transparent #333 transparent transparent;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      margin-left: 6px;
    }

    .sidebar.collapsed a:hover::before {
      opacity: 1;
      visibility: visible;
    }

    /* Conteúdo Principal */
    .main-content {
      margin-left: 250px;
      padding: 30px 20px;
      width: calc(100% - 250px);
      transition: margin-left 0.3s ease, width 0.3s ease;
    }

    .sidebar.collapsed + .main-content {
      margin-left: 70px;
      width: calc(100% - 70px);
    }

    .container {
      background-color: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 800px; /* Reduzido de 1000px para 800px */
      margin: 20px auto 0; /* Centralizado horizontalmente e espaçamento acima */
      transition: all 0.3s ease;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
      font-size: 2.2em;
    }

    .section {
      margin-bottom: 35px;
    }

    .section h2 {
      margin-bottom: 20px;
      color: #2c3e50;
      border-bottom: 3px solid #f2f2f2;
      padding-bottom: 6px;
      font-size: 1.8em;
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #2c3e50;
      font-size: 16px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 20px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      resize: vertical;
      font-size: 16px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    textarea:focus {
      border-color: #d9534f;
      outline: none;
      box-shadow: 0 0 5px rgba(217, 83, 79, 0.5);
    }

    textarea {
      min-height: 100px;
    }

    button {
      background-color: #d9534f;
      color: white;
      padding: 14px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease, transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      font-weight: 500;
    }

    button:hover {
      background-color: rgba(201, 48, 44, 0.4); /* Ajustado para maior opacidade */
      transform: translateY(-3px);
    }

    #referralsList,
    #notificationsList {
      margin-top: 20px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ced4da;
      padding: 14px 18px;
      text-align: left;
      font-size: 16px;
    }

    th {
      background-color: #f2f2f2;
      color: #2c3e50;
    }

    /* Botão de download destacado */
    .download-btn {
      background-color: #28a745;
      color: white;
      padding: 14px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, transform 0.3s ease;
      cursor: pointer;
      font-weight: 500;
      margin-top: 20px;
    }

    .download-btn:hover {
      background-color: #218838;
      transform: translateY(-3px);
    }

    /* Responsividade */
    @media (max-width: 992px) {
      .main-content {
        padding: 25px 15px;
      }

      .sidebar.collapsed + .main-content {
        margin-left: 70px;
        width: calc(100% - 70px);
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
      }

      .sidebar h2 {
        display: none;
      }

      .sidebar a span {
        display: none;
      }

      .sidebar.collapsed {
        width: 250px;
      }

      .sidebar.collapsed a span {
        display: inline;
      }

      .main-content {
        margin-left: 70px;
        width: calc(100% - 70px);
      }

      .sidebar.collapsed + .main-content {
        margin-left: 250px;
        width: calc(100% - 250px);
      }
    }

    @media (max-width: 600px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }

      .main-content {
        margin-left: 0;
        width: 100%;
      }

      button {
        width: 100%;
      }

      table,
      th,
      td {
        display: block;
      }

      th,
      td {
        width: 100%;
        box-sizing: border-box;
      }

      th {
        background-color: #f2f2f2;
      }
    }

    /* Estilo para mensagens de sucesso e erro */
    .message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 6px;
      font-size: 15px;
      animation: fadeIn 0.5s ease-in-out;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
    }

    /* Estilo para aba ativa */
    .sidebar a.active,
    .sidebar .submenu a.active-sub {
      background-color: #c9302c;
      padding-left: 25px;
      font-weight: bold;
      border-left: 5px solid #a71d2a;
      box-shadow: inset 5px 0 0 #a71d2a;
      color: white;
    }

    /* Estilo para submenu ativo */
    .sidebar .submenu a.active-sub {
      background-color: #c9302c;
      padding-left: 30px;
      font-weight: bold;
      border-left: 3px solid #a71d2a;
      color: white;
    }

    /* Transições para submenu */
    .sidebar .submenu {
      transition: all 0.3s ease;
    }

    /* Spinner para carregamento */
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #d9534f;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    /* Botões de Ação */
    .action-btn {
      background: none;
      border: none;
      color: #d9534f;
      cursor: pointer;
      font-size: 1em;
      margin-left: 10px;
      transition: color 0.3s ease;
    }

    .action-btn:hover {
      color: #c9302c;
    }

    /* Ícones nos botões de ação */
    .action-btn i {
      font-size: 1.2em;
    }

    /* Container de ações */
    .actions {
      display: flex;
      align-items: center;
    }

    @media (max-width: 768px) {
      /* Aumentar o tamanho dos ícones para melhor toque */
      .action-btn i {
        font-size: 1.5em;
      }

      /* Ajustar espaçamento nas ações */
      .actions {
        flex-direction: column;
        gap: 5px;
      }
    }

    /* Ajustes nas Tabelas para Mobile */
    @media (max-width: 768px) {
      table, th, td {
        font-size: 14px;
      }

      th, td {
        padding: 10px 12px;
      }
    }

    /* Animações */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- Tela de Login -->
  <div class="login-container" id="loginContainer" aria-hidden="true">
    <div class="login-box" role="dialog" aria-labelledby="loginTitle">
      <h2 id="loginTitle">Login</h2>
      <form id="loginForm" aria-label="Formulário de Login">
        <input type="text" id="username" name="username" placeholder="Usuário" aria-label="Usuário" required />
        <input type="password" id="password" name="password" placeholder="Senha" aria-label="Senha" required />
        <button type="submit" aria-label="Entrar">Entrar</button>
      </form>
      <div id="loginFeedback" role="alert" aria-live="polite"></div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar" aria-label="Sidebar de Navegação" style="display: none;">
    <!-- Logo no Topo da Sidebar -->
    <div class="logo">
      <img src="./homelogo.png" alt="Eng Pag Logo" />
    </div>
    <button class="toggle-btn" onclick="toggleSidebar()" aria-label="Toggle Sidebar">
      <i class="fas fa-chevron-left" aria-hidden="true"></i>
    </button>
    <a href="#" class="active" onclick="showSection('notifications')" role="button" aria-label="Notificações" title="Notificações">
      <i class="fas fa-bell" aria-hidden="true"></i>
      <span>Notificações</span>
    </a>
    <div class="submenu" aria-label="Submenu de Notificações">
      <a href="#" onclick="showSubSection('sendUser')" role="button" aria-label="Enviar para Usuário" title="Enviar para Usuário">
        <i class="fas fa-user-plus" aria-hidden="true"></i>
        <span>Enviar para Usuário</span>
      </a>
      <a href="#" onclick="showSubSection('sendAll')" role="button" aria-label="Enviar para Todos" title="Enviar para Todos">
        <i class="fas fa-users" aria-hidden="true"></i>
        <span>Enviar para Todos</span>
      </a>
      <a href="#" onclick="showSubSection('viewByCpf')" role="button" aria-label="Visualizar por CPF" title="Visualizar por CPF">
        <i class="fas fa-search" aria-hidden="true"></i>
        <span>Visualizar por CPF</span>
      </a>
    </div>
    <!-- Seção de Indicações -->
    <a href="#" onclick="showSection('referrals')" role="button" aria-label="Indicações" title="Indicações">
      <i class="fas fa-user-friends" aria-hidden="true"></i>
      <span>Indicações</span>
    </a>
    <a href="#" onclick="logout()" role="button" aria-label="Sair" title="Sair">
      <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
      <span>Sair</span>
    </a>
  </div>

  <!-- Conteúdo Principal -->
  <div class="main-content" id="mainContent" aria-label="Conteúdo Principal" style="display: none;">
    <div class="container">
      <h1>Gerenciador - Eng Pag</h1>

      <!-- Seção de Notificações -->
      <div id="notificationsSection" class="section">
        <!-- Subseção: Enviar Mensagem para Usuário -->
        <div id="sendUserSection">
          <h2>Enviar Mensagem para Usuário</h2>
          <label for="cpf">CPF do Usuário:</label>
          <input type="text" id="cpf" placeholder="Ex: 12345678901" aria-label="CPF do Usuário" />

          <label for="userSubject">Assunto:</label>
          <input type="text" id="userSubject" placeholder="Assunto da mensagem" aria-label="Assunto da Mensagem" />

          <label for="userMessage">Mensagem:</label>
          <textarea id="userMessage" placeholder="Escreva sua mensagem..." aria-label="Mensagem"></textarea>

          <button onclick="sendMessageToUser()" aria-label="Enviar Mensagem">
            <i class="fas fa-paper-plane" aria-hidden="true"></i> Enviar Mensagem
            <div id="sendUserSpinner" class="spinner" style="display: none;" aria-hidden="true"></div>
          </button>

          <div id="userFeedback" role="alert" aria-live="polite"></div>
        </div>

        <!-- Subseção: Enviar Mensagem para Todos Usuários -->
        <div id="sendAllSection" style="display: none">
          <h2>Enviar Mensagem para Todos Usuários</h2>

          <label for="allUsersSubject">Assunto:</label>
          <input type="text" id="allUsersSubject" placeholder="Assunto da mensagem" aria-label="Assunto da Mensagem" />

          <label for="allUsersMessage">Mensagem:</label>
          <textarea id="allUsersMessage" placeholder="Escreva sua mensagem para todos..." aria-label="Mensagem para Todos"></textarea>

          <button onclick="sendMessageToAll()" aria-label="Enviar Mensagem para Todos">
            <i class="fas fa-paper-plane" aria-hidden="true"></i> Enviar Mensagem para Todos
            <div id="sendAllSpinner" class="spinner" style="display: none;" aria-hidden="true"></div>
          </button>

          <div id="allUsersFeedback" role="alert" aria-live="polite"></div>
        </div>

        <!-- Subseção: Visualizar Notificações por CPF -->
        <div id="viewByCpfSection" style="display: none">
          <h2>Visualizar Notificações por CPF</h2>
          <label for="viewCpf">CPF do Usuário:</label>
          <input type="text" id="viewCpf" placeholder="Ex: 12345678901" aria-label="CPF do Usuário" />
          <button onclick="viewNotificationsByCpf()" aria-label="Visualizar Notificações">
            <i class="fas fa-search" aria-hidden="true"></i> Visualizar Notificações
            <div id="viewCpfSpinner" class="spinner" style="display: none;" aria-hidden="true"></div>
          </button>

          <div id="notificationsList"></div>
        </div>
      </div>

      <!-- Seção de Indicações -->
      <div id="referralsSection" class="section" style="display: none">
        <h2>Verificar Indicações</h2>
        <button onclick="showReferrals()" aria-label="Ver Indicações">
          <i class="fas fa-eye" aria-hidden="true"></i> Ver Indicações
          <div id="showReferralsSpinner" class="spinner" style="display: none;" aria-hidden="true"></div>
        </button>
        <div id="referralsList"></div>
        <button class="download-btn" onclick="downloadPDF()" aria-label="Baixar Relatório em PDF">
          <i class="fas fa-file-pdf" aria-hidden="true"></i> Baixar Relatório em PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    // URL do seu backend
    const backendUrl = "https://engpag.backend.gustavohenrique.dev";

    // Elementos de login
    const loginContainer = document.getElementById("loginContainer");
    const mainContent = document.getElementById("mainContent");
    const sidebar = document.getElementById("sidebar");
    const loginForm = document.getElementById("loginForm");
    const loginFeedback = document.getElementById("loginFeedback");

    // Verificar se o usuário está logado
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      if (token) {
        loginContainer.style.display = "none";
        mainContent.style.display = "block";
        sidebar.style.display = "flex";
        showSection("notifications");
        showSubSection("sendUser");
      } else {
        loginContainer.style.display = "flex";
        mainContent.style.display = "none";
        sidebar.style.display = "none";
      }
    });

    // Função de login
    loginForm.addEventListener("submit", async function(event) {
      event.preventDefault(); // Evitar o comportamento padrão do formulário

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      loginFeedback.innerHTML = "";

      if (username === "" || password === "") {
        loginFeedback.innerHTML =
          '<div class="message error">Por favor, preencha o usuário e a senha.</div>';
        return;
      }

      // Mostrar feedback de carregamento
      loginFeedback.innerHTML =
        '<div class="message success">Autenticando...</div>';

      try {
        const response = await fetch(`${backendUrl}/login`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ login: username, senha: password }),
        });

        if (response.ok) {
          const data = await response.json();
          const token = data.token;

          // Armazenar o token no localStorage
          localStorage.setItem("token", token);

          loginFeedback.innerHTML =
            '<div class="message success">Login bem-sucedido! Redirecionando...</div>';

          // Redirecionar após um breve intervalo
          setTimeout(() => {
            loginContainer.style.display = "none";
            mainContent.style.display = "block";
            sidebar.style.display = "flex";
            showSection("notifications");
            showSubSection("sendUser");
          }, 1000);
        } else {
          const errorData = await response.json();
          loginFeedback.innerHTML =
            `<div class="message error">${errorData.mensagem || 'Erro no login.'}</div>`;
        }
      } catch (error) {
        console.error("Erro ao realizar login:", error);
        loginFeedback.innerHTML =
          '<div class="message error">Erro ao realizar login. Tente novamente mais tarde.</div>';
      }
    });

    // Função de logout
    function logout() {
      localStorage.removeItem("token");
      window.location.reload();
    }

    // Middleware para incluir o token nas requisições
    function getAuthHeaders() {
      const token = localStorage.getItem("token");
      return token ? { 'Authorization': `Bearer ${token}` } : {};
    }

    // Função para alternar a sidebar
    function toggleSidebar() {
      const toggleBtnIcon = sidebar.querySelector(".toggle-btn i");
      sidebar.classList.toggle("collapsed");

      // Alterar o ícone conforme o estado da sidebar
      if (sidebar.classList.contains("collapsed")) {
        toggleBtnIcon.classList.remove("fa-chevron-left");
        toggleBtnIcon.classList.add("fa-chevron-right");

        // Adicionar classe para tooltips personalizados
        const sidebarLinks = sidebar.querySelectorAll("a");
        sidebarLinks.forEach(link => {
          link.classList.add("collapsed-tooltip");
          link.setAttribute("data-tooltip", link.querySelector("span").textContent.trim());
        });
      } else {
        toggleBtnIcon.classList.remove("fa-chevron-right");
        toggleBtnIcon.classList.add("fa-chevron-left");

        // Remover classe de tooltips personalizados
        const sidebarLinks = sidebar.querySelectorAll("a");
        sidebarLinks.forEach(link => {
          link.classList.remove("collapsed-tooltip");
          link.removeAttribute("data-tooltip");
        });
      }
    }

    // Função para alternar seções principais
    function showSection(section) {
      const notificationsSection = document.getElementById("notificationsSection");
      const referralsSection = document.getElementById("referralsSection");
      const sidebarLinks = document.querySelectorAll(".sidebar a");

      sidebarLinks.forEach((link) => {
        link.classList.remove("active");
      });

      if (section === "notifications") {
        notificationsSection.style.display = "block";
        referralsSection.style.display = "none";
        sidebarLinks.forEach((link) => {
          if (link.textContent.trim() === "Notificações") {
            link.classList.add("active");
          }
        });
        // Mostrar submenu
        toggleSubmenu("Notificações");
      } else if (section === "referrals") {
        notificationsSection.style.display = "none";
        referralsSection.style.display = "block";
        sidebarLinks.forEach((link) => {
          if (link.textContent.trim() === "Indicações") {
            link.classList.add("active");
          }
        });
        // Ocultar submenu
        hideSubmenu();
      }
    }

    // Função para alternar subseções dentro de Notificações
    function showSubSection(subSection) {
      const sendUserSection = document.getElementById("sendUserSection");
      const sendAllSection = document.getElementById("sendAllSection");
      const viewByCpfSection = document.getElementById("viewByCpfSection");
      const submenuLinks = document.querySelectorAll(".submenu a");

      submenuLinks.forEach((link) => {
        link.classList.remove("active-sub");
      });

      if (subSection === "sendUser") {
        sendUserSection.style.display = "block";
        sendAllSection.style.display = "none";
        viewByCpfSection.style.display = "none";
        submenuLinks.forEach((link) => {
          if (link.textContent.trim() === "Enviar para Usuário") {
            link.classList.add("active-sub");
          }
        });
      } else if (subSection === "sendAll") {
        sendUserSection.style.display = "none";
        sendAllSection.style.display = "block";
        viewByCpfSection.style.display = "none";
        submenuLinks.forEach((link) => {
          if (link.textContent.trim() === "Enviar para Todos") {
            link.classList.add("active-sub");
          }
        });
      } else if (subSection === "viewByCpf") {
        sendUserSection.style.display = "none";
        sendAllSection.style.display = "none";
        viewByCpfSection.style.display = "block";
        submenuLinks.forEach((link) => {
          if (link.textContent.trim() === "Visualizar por CPF") {
            link.classList.add("active-sub");
          }
        });
      }
    }

    // Função para alternar a visibilidade do submenu
    function toggleSubmenu(menuName) {
      const submenu = document.querySelector(".sidebar .submenu");
      const parentLink = Array.from(
        document.querySelectorAll(".sidebar a")
      ).find((link) => link.textContent.trim() === menuName);
      if (submenu.style.display === "flex") {
        submenu.style.display = "none";
        parentLink.classList.remove("active");
      } else {
        submenu.style.display = "flex";
        parentLink.classList.add("active");
      }
    }

    // Função para esconder submenu
    function hideSubmenu() {
      const submenu = document.querySelector(".sidebar .submenu");
      const parentLink = Array.from(
        document.querySelectorAll(".sidebar a")
      ).find((link) => link.textContent.trim() === "Notificações");
      submenu.style.display = "none";
      parentLink.classList.remove("active");
    }

    // Função para enviar mensagem para um usuário específico
    async function sendMessageToUser() {
      const cpf = document.getElementById("cpf").value.trim();
      const subject = document.getElementById("userSubject").value.trim();
      const message = document.getElementById("userMessage").value.trim();
      const feedback = document.getElementById("userFeedback");
      const spinner = document.getElementById("sendUserSpinner");

      feedback.innerHTML = "";

      if (cpf === "" || subject === "" || message === "") {
        feedback.innerHTML =
          '<div class="message error">Por favor, preencha o CPF, assunto e a mensagem.</div>';
        return;
      }

      spinner.style.display = "block"; // Mostrar spinner

      try {
        const response = await fetch(`${backendUrl}/send-message`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...getAuthHeaders(),
          },
          body: JSON.stringify({ cpf, subject, message }),
        });

        if (response.ok) {
          const result = await response.text();
          feedback.innerHTML = `<div class="message success">${result}</div>`;
          // Limpar campos após envio
          document.getElementById("cpf").value = "";
          document.getElementById("userSubject").value = "";
          document.getElementById("userMessage").value = "";
        } else {
          const errorText = await response.text();
          feedback.innerHTML = `<div class="message error">Erro: ${errorText}</div>`;
        }
      } catch (error) {
        console.error("Erro ao enviar mensagem:", error);
        feedback.innerHTML =
          '<div class="message error">Erro ao enviar mensagem.</div>';
      } finally {
        spinner.style.display = "none"; // Esconder spinner
      }
    }

    // Função para enviar mensagem para todos os usuários
    async function sendMessageToAll() {
      const subject = document.getElementById("allUsersSubject").value.trim();
      const message = document.getElementById("allUsersMessage").value.trim();
      const feedback = document.getElementById("allUsersFeedback");
      const spinner = document.getElementById("sendAllSpinner");

      feedback.innerHTML = "";

      if (subject === "" || message === "") {
        feedback.innerHTML =
          '<div class="message error">Por favor, preencha o assunto e a mensagem.</div>';
        return;
      }

      spinner.style.display = "block"; // Mostrar spinner

      try {
        const response = await fetch(`${backendUrl}/send-message-all`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...getAuthHeaders(),
          },
          body: JSON.stringify({ subject, message }),
        });

        if (response.ok) {
          const result = await response.text();
          feedback.innerHTML = `<div class="message success">${result}</div>`;
          // Limpar campos após envio
          document.getElementById("allUsersSubject").value = "";
          document.getElementById("allUsersMessage").value = "";
        } else {
          const errorText = await response.text();
          feedback.innerHTML = `<div class="message error">Erro: ${errorText}</div>`;
        }
      } catch (error) {
        console.error("Erro ao enviar mensagem para todos:", error);
        feedback.innerHTML =
          '<div class="message error">Erro ao enviar mensagem para todos.</div>';
      } finally {
        spinner.style.display = "none"; // Esconder spinner
      }
    }

    // Função para visualizar notificações por CPF
    async function viewNotificationsByCpf() {
      const cpf = document.getElementById("viewCpf").value.trim();
      const notificationsList = document.getElementById("notificationsList");
      const spinner = document.getElementById("viewCpfSpinner");
      notificationsList.innerHTML = ""; // Limpar conteúdo anterior

      if (cpf === "") {
        notificationsList.innerHTML =
          '<div class="message error">Por favor, preencha o CPF.</div>';
        return;
      }

      spinner.style.display = "block"; // Mostrar spinner

      try {
        // Atualização: Usando query parameter para CPF
        const response = await fetch(`${backendUrl}/notifications?cpf=${encodeURIComponent(cpf)}`, {
          headers: {
            ...getAuthHeaders(),
          },
        });
        if (response.ok) {
          const notifications = await response.json();

          if (!Array.isArray(notifications) || notifications.length === 0) {
            notificationsList.innerHTML =
              "<p>Nenhuma notificação encontrada para este CPF.</p>";
            return;
          }

          let html = "<table>";
          html += "<tr><th>Data</th><th>Assunto</th><th>Mensagem</th><th>Ações</th></tr>";

          notifications.forEach((notification) => {
            const date = notification.dateSent
              ? new Date(notification.dateSent).toLocaleDateString("pt-BR")
              : "";
            html += `<tr id="notification-${notification._id}">
                      <td>${date}</td>
                      <td id="subject-${notification._id}">${notification.subject || ""}</td>
                      <td id="message-${notification._id}">${notification.message || ""}</td>
                      <td class="actions">
                        <button class="action-btn edit-btn" onclick="editNotification('${notification._id}')">
                          <i class="fas fa-edit" aria-hidden="true"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteNotification('${notification._id}')">
                          <i class="fas fa-trash" aria-hidden="true"></i>
                        </button>
                      </td>
                    </tr>`;
          });
          html += "</table>";

          notificationsList.innerHTML = html;
        } else {
          const errorText = await response.text();
          notificationsList.innerHTML = `<div class="message error">Erro: ${errorText}</div>`;
        }
      } catch (error) {
        console.error("Erro ao buscar notificações:", error);
        notificationsList.innerHTML =
          '<div class="message error">Erro ao buscar notificações.</div>';
      } finally {
        spinner.style.display = "none"; // Esconder spinner
      }
    }

    // Função para editar uma notificação
    function editNotification(id) {
      const subjectElement = document.getElementById(`subject-${id}`);
      const messageElement = document.getElementById(`message-${id}`);

      const currentSubject = subjectElement.textContent;
      const currentMessage = messageElement.textContent;

      // Substituir o texto por campos de entrada
      subjectElement.innerHTML = `<input type="text" id="edit-subject-${id}" value="${currentSubject}" />`;
      messageElement.innerHTML = `<textarea id="edit-message-${id}">${currentMessage}</textarea>`;

      // Alterar os botões de ação
      const actionsCell = document.querySelector(`#notification-${id} .actions`);
      actionsCell.innerHTML = `
        <button class="action-btn save-btn" onclick="saveEditNotification('${id}')">
          <i class="fas fa-save" aria-hidden="true"></i>
        </button>
        <button class="action-btn cancel-btn" onclick="cancelEditNotification('${id}', '${currentSubject.replace(/'/g, "\\'")}', '${currentMessage.replace(/'/g, "\\'")}')">
          <i class="fas fa-times" aria-hidden="true"></i>
        </button>
      `;
    }

    // Função para salvar a edição da notificação
    async function saveEditNotification(id) {
      const newSubject = document.getElementById(`edit-subject-${id}`).value.trim();
      const newMessage = document.getElementById(`edit-message-${id}`).value.trim();

      if (newSubject === "" || newMessage === "") {
        alert('Assunto e mensagem não podem estar vazios.');
        return;
      }

      try {
        const response = await fetch(`${backendUrl}/notifications/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            ...getAuthHeaders(),
          },
          body: JSON.stringify({ subject: newSubject, message: newMessage }),
        });

        if (response.ok) {
          const updatedNotification = await response.json();
          // Atualizar a tabela com os novos valores
          document.getElementById(`subject-${id}`).textContent = updatedNotification.subject;
          document.getElementById(`message-${id}`).textContent = updatedNotification.message;

          // Restaurar os botões de ação
          const actionsCell = document.querySelector(`#notification-${id} .actions`);
          actionsCell.innerHTML = `
            <button class="action-btn edit-btn" onclick="editNotification('${id}')">
              <i class="fas fa-edit" aria-hidden="true"></i>
            </button>
            <button class="action-btn delete-btn" onclick="deleteNotification('${id}')">
              <i class="fas fa-trash" aria-hidden="true"></i>
            </button>
          `;

          alert('Notificação atualizada com sucesso');
        } else {
          const errorText = await response.text();
          alert(`Erro ao editar notificação: ${errorText}`);
        }
      } catch (error) {
        console.error('Erro ao editar notificação:', error);
        alert('Erro ao editar notificação.');
      }
    }

    // Função para cancelar a edição da notificação
    function cancelEditNotification(id, originalSubject, originalMessage) {
      // Restaurar os valores originais
      document.getElementById(`subject-${id}`).textContent = originalSubject;
      document.getElementById(`message-${id}`).textContent = originalMessage;

      // Restaurar os botões de ação
      const actionsCell = document.querySelector(`#notification-${id} .actions`);
      actionsCell.innerHTML = `
        <button class="action-btn edit-btn" onclick="editNotification('${id}')">
          <i class="fas fa-edit" aria-hidden="true"></i>
        </button>
        <button class="action-btn delete-btn" onclick="deleteNotification('${id}')">
          <i class="fas fa-trash" aria-hidden="true"></i>
        </button>
      `;
    }

    // Função para deletar uma notificação
    async function deleteNotification(id) {
      if (!confirm('Tem certeza de que deseja deletar esta notificação?')) {
        return;
      }

      try {
        const response = await fetch(`${backendUrl}/notifications/${id}`, {
          method: 'DELETE',
          headers: {
            ...getAuthHeaders(),
          },
        });

        if (response.ok) {
          // Remover a linha da tabela
          const row = document.getElementById(`notification-${id}`);
          if (row) {
            row.remove();
          }
          alert('Notificação deletada com sucesso');
        } else {
          const errorText = await response.text();
          alert(`Erro ao deletar notificação: ${errorText}`);
        }
      } catch (error) {
        console.error('Erro ao deletar notificação:', error);
        alert('Erro ao deletar notificação.');
      }
    }

    // Função para exibir indicações
    async function showReferrals() {
      const referralsList = document.getElementById("referralsList");
      const spinner = document.getElementById("showReferralsSpinner");
      referralsList.innerHTML = ""; // Limpar conteúdo anterior

      spinner.style.display = "block"; // Mostrar spinner

      try {
        const response = await fetch(`${backendUrl}/referrals`, {
          headers: {
            ...getAuthHeaders(),
          },
        });
        if (response.ok) {
          const referrals = await response.json();

          if (!Array.isArray(referrals) || referrals.length === 0) {
            referralsList.innerHTML = "<p>Nenhuma indicação encontrada.</p>";
            return;
          }

          let html = "<table>";
          html +=
            "<tr><th>Data</th><th>Quem Indicou</th><th>Amigo Indicado</th><th>Empreendimento</th><th>E-mail</th><th>Telefone</th><th>Observações</th><th>Ações</th></tr>";

          referrals.forEach((referral) => {
            const date = referral.dateReferred
              ? new Date(referral.dateReferred).toLocaleDateString("pt-BR")
              : "";
            html += `<tr id="referral-${referral._id}">
                      <td>${date}</td>
                      <td>${referral.referrerName || ""}</td>
                      <td>${referral.friendName || ""}</td>
                      <td>${referral.empreendimento || ""}</td>
                      <td>${referral.email || ""}</td>
                      <td>${referral.telefone || ""}</td>
                      <td>${referral.observacoes || ""}</td>
                      <td class="actions">
                        <button class="action-btn delete-btn" onclick="deleteReferral('${referral._id}')">
                          <i class="fas fa-trash" aria-hidden="true"></i>
                        </button>
                      </td>
                    </tr>`;
          });
          html += "</table>";

          referralsList.innerHTML = html;
        } else {
          const errorText = await response.text();
          referralsList.innerHTML = `<div class="message error">Erro: ${errorText}</div>`;
        }
      } catch (error) {
        console.error("Erro ao buscar indicações:", error);
        referralsList.innerHTML =
          '<div class="message error">Erro ao buscar indicações.</div>';
      } finally {
        spinner.style.display = "none"; // Esconder spinner
      }
    }

    // Função para deletar uma indicação
    async function deleteReferral(id) {
      if (!confirm('Tem certeza de que deseja deletar esta indicação?')) {
        return;
      }

      try {
        const response = await fetch(`${backendUrl}/referrals/${id}`, {
          method: 'DELETE',
          headers: {
            ...getAuthHeaders(),
          },
        });

        if (response.ok) {
          // Remover a linha da tabela
          const row = document.getElementById(`referral-${id}`);
          if (row) {
            row.remove();
          }
          alert('Indicação deletada com sucesso');
        } else {
          const errorText = await response.text();
          alert(`Erro ao deletar indicação: ${errorText}`);
        }
      } catch (error) {
        console.error('Erro ao deletar indicação:', error);
        alert('Erro ao deletar indicação.');
      }
    }

    // Função para baixar relatório em PDF
    function downloadPDF() {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Você precisa estar logado para baixar o relatório.");
        return;
      }

      const link = document.createElement("a");
      link.href = `${backendUrl}/referrals/report`;
      link.target = "_blank";
      link.download = "relatorio_indicacoes.pdf";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Acessibilidade: Navegação via teclado
    document.addEventListener('keydown', function(event) {
      // Fechar a sidebar colapsada com a tecla Esc
      if (event.key === "Escape" && sidebar.classList.contains("collapsed")) {
        toggleSidebar();
      }
    });
  </script>
</body>
</html>
