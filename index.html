<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Gerenciador - EngePag</title>
    <!-- Font Awesome para ícones -->
    <script
      src="https://kit.fontawesome.com/2bd16d993e.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts para uma fonte mais agradável -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>

      /* Container principal */
#notificationsList {
  overflow-x: auto;
  margin-top: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Tabela */
#notificationsList table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

/* Cabeçalhos */
#notificationsList th {
  background-color: #f8f9fa;
  padding: 12px 15px;
  text-align: left;
  font-weight: 600;
  border-bottom: 2px solid #dee2e6;
}

/* Células */
#notificationsList td {
  padding: 12px 15px;
  border-bottom: 1px solid #e9ecef;
  vertical-align: top;
}

/* Colunas específicas */
.date-column { width: 120px; }
.subject-column { width: 25%; }
.message-column { width: 40%; }
.status-column { width: 120px; }
.actions-column { width: 100px; }

/* Quebra de linha para conteúdo longo */
.message-column {
  word-break: break-word;
  max-width: 400px;
}
      /* Reset básico para consistência */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", sans-serif;
        background-color: #f9fafb;
        color: #333;
        min-height: 100vh;
        display: flex;
        transition: all 0.3s ease;
      }

      .checkbox-container {
        margin-bottom: 20px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
      }

      .checkbox-label input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .checkbox-label span {
        color: #333;
        font-size: 16px;
      }

      /* Tela de Login */
      .login-container {
        display: none; /* Inicialmente escondida */
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100vh;
        background-color: rgba(249, 250, 251, 0.95);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
      }

      .login-box {
        background-color: #ffffff;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        width: 350px;
        text-align: center;
        animation: fadeIn 0.5s ease-in-out;
      }

      .login-box h2 {
        margin-bottom: 25px;
        color: #d9534f; /* Tom de vermelho mais suave */
        font-size: 1.8em;
      }

      .login-box input[type="text"],
      .login-box input[type="password"] {
        width: 100%;
        padding: 12px 14px;
        margin-bottom: 20px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .login-box input[type="text"]:focus,
      .login-box input[type="password"]:focus {
        border-color: #d9534f;
        outline: none;
        box-shadow: 0 0 5px rgba(217, 83, 79, 0.5);
      }

      .login-box button {
        background-color: #d9534f;
        color: white;
        padding: 14px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease, transform 0.3s ease;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
      }

      .login-box button:hover {
        background-color: rgba(
          201,
          48,
          44,
          0.4
        ); /* Ajustado para maior opacidade */
        transform: translateY(-3px);
      }

      .login-box .message {
        margin-top: 20px;
        padding: 12px;
        border-radius: 6px;
        font-size: 15px;
        animation: fadeIn 0.5s ease-in-out;
      }

      .login-box .success {
        background-color: #d4edda;
        color: #155724;
      }

      .login-box .error {
        background-color: #f8d7da;
        color: #721c24;
      }

      /* Sidebar */
      .sidebar {
        width: 250px;
        background-color: #f6d7d7; /* Nova cor da sidebar */
        color: #333;
        display: flex;
        flex-direction: column;
        padding-top: 20px;
        position: fixed;
        height: 100vh;
        transition: width 0.3s ease, background-color 0.3s ease;
        overflow: hidden;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
      }

      .sidebar.collapsed {
        width: 70px;
      }

      /* Logo na Sidebar */
      .sidebar .logo {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 25px auto; /* Centraliza horizontalmente e adiciona margem inferior */
        padding: 5px;
        border-radius: 8px;
        max-width: 180px; /* Limita a largura máxima */
        transition: max-width 0.3s ease;
      }

      .sidebar.collapsed .logo {
        max-width: 50px; /* Reduz a largura quando colapsada */
      }

      .sidebar .logo img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        transition: transform 0.3s ease;
      }

      .sidebar.collapsed .logo img {
        transform: scale(0.7); /* Reduz a logo quando colapsada */
      }

      .sidebar h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #ecf0f1;
        font-size: 1.5em;
        display: none; /* Removido o título */
      }

      .sidebar a {
        padding: 14px 20px;
        text-decoration: none;
        color: #333;
        background-color: transparent;
        display: flex;
        align-items: center;
        transition: background-color 0.3s, padding 0.3s, box-shadow 0.3s,
          color 0.3s;
        white-space: nowrap;
        position: relative;
        border-left: 5px solid transparent;
        border-radius: 8px;
        margin: 6px 10px;
        font-size: 16px;
        font-weight: 500;
      }

      .sidebar a i {
        margin-right: 12px; /* Espaço entre ícone e texto */
        font-size: 1.5em; /* Aumentado para melhor visibilidade */
        color: #d9534f; /* Ícones com tom de vermelho */
        transition: color 0.3s;
      }

      .sidebar.collapsed a i {
        margin-right: 0; /* Remover margem quando colapsado */
        font-size: 1.8em; /* Aumentar ainda mais quando colapsado */
        color: #ffffff; /* Cor branca para contraste */
      }

      .sidebar a span {
        transition: opacity 0.3s ease;
      }

      .sidebar.collapsed a span {
        opacity: 0;
        visibility: hidden;
        width: 0;
        display: none;
      }

      .sidebar a:hover {
        background-color: #f8c6c6; /* Fundo mais claro no hover */
        padding-left: 25px;
        border-left: 5px solid #d9534f;
        box-shadow: inset 5px 0 0 #d9534f;
        color: #d9534f; /* Texto no hover muda para vermelho */
      }

      .sidebar a.active {
        background-color: #d9534f;
        padding-left: 25px;
        font-weight: bold;
        border-left: 5px solid #c9302c;
        box-shadow: inset 5px 0 0 #c9302c;
        color: white;
      }

      .sidebar.collapsed a.active {
        background-color: #d9534f;
        border-left: 5px solid #c9302c;
        box-shadow: inset 5px 0 0 #c9302c;
        color: white;
      }

      .sidebar.collapsed a.active i {
        color: white;
      }

      .sidebar.collapsed a.active span {
        display: none;
      }

      .sidebar.collapsed a:hover {
        background-color: #f8c6c6;
        padding-left: 10px;
        border-left: 5px solid #d9534f;
        box-shadow: inset 5px 0 0 #d9534f;
        color: #d9534f;
      }

      .sidebar.collapsed a:hover i {
        color: #d9534f;
      }

      .sidebar.collapsed a:hover span {
        opacity: 0;
        visibility: hidden;
        width: 0;
        display: none;
      }

      .show-on-login-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
      }

      .show-on-login-status.active {
        background-color: #d4edda;
        color: #155724;
      }

      .show-on-login-status:not(.active) {
        background-color: #f8d7da;
        color: #721c24;
      }

      .sidebar .submenu {
        display: none;
        flex-direction: column;
        margin-left: 10px;
      }

      .sidebar .submenu a {
        padding: 10px 20px;
        background-color: #ffe6e6;
        border-left: 3px solid transparent;
        transition: background-color 0.3s, padding-left 0.3s, border-left 0.3s,
          color 0.3s;
        margin: 5px 0;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 400;
        color: #333;
      }

      .sidebar .submenu a i {
        margin-right: 12px; /* Espaço entre ícone e texto nas submenus */
        color: #d9534f;
        transition: color 0.3s;
      }

      .sidebar .submenu a:hover {
        background-color: #f8c6c6;
        padding-left: 30px;
        border-left: 3px solid #d9534f;
        color: #d9534f;
      }

      .sidebar .submenu a.active-sub {
        background-color: #d9534f;
        padding-left: 30px;
        font-weight: bold;
        border-left: 3px solid #a71d2a;
        color: white;
      }

      .sidebar .submenu a.active-sub i {
        color: white;
      }

      /* Botão de toggle da sidebar */
      .toggle-btn {
        background: none;
        border: none;
        color: #333;
        font-size: 1.5em;
        cursor: pointer;
        padding: 10px 20px;
        text-align: right;
        transition: background-color 0.3s, color 0.3s;
        display: flex;
        justify-content: flex-end;
        align-items: center;
      }

      .toggle-btn:hover {
        background-color: #ffe6e6;
        border-radius: 8px;
        color: #d9534f;
      }

      .sidebar.collapsed .toggle-btn {
        justify-content: center;
        padding: 10px;
      }

      .sidebar.collapsed .toggle-btn:hover {
        background-color: #ffe6e6;
        border-radius: 50%;
        color: #d9534f;
      }

      /* Tooltip Personalizado */
      .sidebar a.collapsed-tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        background-color: #333;
        color: #fff;
        padding: 6px 8px;
        border-radius: 4px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
        margin-left: 8px;
        font-size: 14px;
        pointer-events: none;
        z-index: 100;
      }

      .sidebar.collapsed a:hover::after {
        opacity: 1;
        visibility: visible;
      }

      .sidebar a.collapsed-tooltip::before {
        content: "";
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: transparent #333 transparent transparent;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
        margin-left: 6px;
      }

      .sidebar.collapsed a:hover::before {
        opacity: 1;
        visibility: visible;
      }

      /* Conteúdo Principal */
      .main-content {
        margin-left: 250px;
        padding: 30px 20px;
        width: calc(100% - 250px);
        transition: margin-left 0.3s ease, width 0.3s ease;
      }

      .sidebar.collapsed + .main-content {
        margin-left: 70px;
        width: calc(100% - 70px);
      }

      .container {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 1100px; /* Reduzido de 1000px para 800px */
        margin: 20px auto 0; /* Centralizado horizontalmente e espaçamento acima */
        transition: all 0.3s ease;
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #2c3e50;
        font-size: 2.2em;
      }

      .section {
        margin-bottom: 35px;
      }

      .section h2 {
        margin-bottom: 20px;
        color: #2c3e50;
        border-bottom: 3px solid #f2f2f2;
        padding-bottom: 6px;
        font-size: 1.8em;
      }

      label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
        color: #2c3e50;
        font-size: 16px;
      }

      input[type="text"],
      textarea {
        width: 100%;
        padding: 12px 14px;
        margin-bottom: 20px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        resize: vertical;
        font-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      input[type="text"]:focus,
      textarea:focus {
        border-color: #d9534f;
        outline: none;
        box-shadow: 0 0 5px rgba(217, 83, 79, 0.5);
      }

      textarea {
        min-height: 100px;
      }

      button {
        background-color: #d9534f;
        color: white;
        padding: 14px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease, transform 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        font-weight: 500;
      }

      button:hover {
        background-color: rgba(
          201,
          48,
          44,
          0.4
        ); /* Ajustado para maior opacidade */
        transform: translateY(-3px);
      }

      /* Responsividade */
      @media (max-width: 992px) {
        .main-content {
          padding: 25px 15px;
        }

        .sidebar.collapsed + .main-content {
          margin-left: 70px;
          width: calc(100% - 70px);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 70px;
        }

        .sidebar h2 {
          display: none;
        }

        .sidebar a span {
          display: none;
        }

        .sidebar.collapsed {
          width: 250px;
        }

        .sidebar.collapsed a span {
          display: inline;
        }

        .main-content {
          margin-left: 70px;
          width: calc(100% - 70px);
        }

        .sidebar.collapsed + .main-content {
          margin-left: 250px;
          width: calc(100% - 250px);
        }
      }

      @media (max-width: 600px) {
        body {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }

        .main-content {
          margin-left: 0;
          width: 100%;
        }

        button {
          width: 100%;
        }

        table,
        th,
        td {
          display: block;
        }

        th,
        td {
          width: 100%;
          box-sizing: border-box;
        }

        th {
          background-color: #f2f2f2;
        }
      }

      /* Estilo para mensagens de sucesso e erro */
      .message {
        margin-top: 20px;
        padding: 12px;
        border-radius: 6px;
        font-size: 15px;
        animation: fadeIn 0.5s ease-in-out;
      }

      .success {
        background-color: #d4edda;
        color: #155724;
      }

      .error {
        background-color: #f8d7da;
        color: #721c24;
      }

      /* Estilo para aba ativa */
      .sidebar a.active,
      .sidebar .submenu a.active-sub {
        background-color: #c9302c;
        padding-left: 25px;
        font-weight: bold;
        border-left: 5px solid #a71d2a;
        box-shadow: inset 5px 0 0 #a71d2a;
        color: white;
      }

      /* Estilo para submenu ativo */
      .sidebar .submenu a.active-sub {
        background-color: #c9302c;
        padding-left: 30px;
        font-weight: bold;
        border-left: 3px solid #a71d2a;
        color: white;
      }

      /* Transições para submenu */
      .sidebar .submenu {
        transition: all 0.3s ease;
      }

      /* Spinner para carregamento */
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #d9534f;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      /* Botões de Ação */
      .action-btn {
        background: none;
        border: none;
        color: #d9534f;
        cursor: pointer;
        font-size: 1em;
        margin-left: 10px;
        transition: color 0.3s ease;
      }

      .action-btn:hover {
        color: #c9302c;
      }

      /* Ícones nos botões de ação */
      .action-btn i {
        font-size: 1.2em;
      }

      /* Container de ações */
      .actions {
        display: flex;
        align-items: center;
      }

      @media (max-width: 768px) {
        /* Aumentar o tamanho dos ícones para melhor toque */
        .action-btn i {
          font-size: 1.5em;
        }

        /* Ajustar espaçamento nas ações */
        .actions {
          flex-direction: column;
          gap: 5px;
        }
      }

      /* Ajustes nas Tabelas para Mobile */
      @media (max-width: 768px) {
        table,
        th,
        td {
          font-size: 14px;
        }

        th,
        td {
          padding: 10px 12px;
        }
      }

      /* Animações */
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .excel-instructions {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .excel-instructions h3 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .excel-instructions ul {
        list-style-type: none;
        padding-left: 0;
      }

      .excel-instructions li {
        margin: 8px 0;
        padding-left: 20px;
        position: relative;
      }

      .excel-instructions li:before {
        content: "•";
        position: absolute;
        left: 0;
        color: #d9534f;
      }

      .file-input-container {
        margin-bottom: 20px;
      }

      .upload-form {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      #uploadResults {
        margin-top: 20px;
      }

      #uploadResults table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      #uploadResults th,
      #uploadResults td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      #uploadResults th {
        background-color: #f8f9fa;
        font-weight: bold;
      }

      .status-success {
        color: #155724;
        background-color: #d4edda;
        padding: 2px 8px;
        border-radius: 4px;
      }

      .status-error {
        color: #721c24;
        background-color: #f8d7da;
        padding: 2px 8px;
        border-radius: 4px;
      }

      .preview-container {
        margin-top: 20px;
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .preview-controls {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
      }

      .preview-table {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
      }

      .preview-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .preview-table th,
      .preview-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .preview-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
      }

      .secondary-button {
        background-color: #6c757d;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .secondary-button:hover {
        background-color: #5a6268;
      }

      .row-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .invalid-row {
        background-color: #fff3f3;
      }

      .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <div class="login-container" id="loginContainer" aria-hidden="true">
      <div class="login-box" role="dialog" aria-labelledby="loginTitle">
        <h2 id="loginTitle">Login</h2>
        <form id="loginForm" aria-label="Formulário de Login">
          <input
            type="text"
            id="username"
            name="username"
            placeholder="Usuário"
            aria-label="Usuário"
            required
          />
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Senha"
            aria-label="Senha"
            required
          />
          <button type="submit" aria-label="Entrar">Entrar</button>
        </form>
        <div id="loginFeedback" role="alert" aria-live="polite"></div>
      </div>
    </div>

    <!-- Sidebar -->
    <div
      class="sidebar"
      id="sidebar"
      aria-label="Sidebar de Navegação"
      style="display: none"
    >
      <!-- Logo no Topo da Sidebar -->
      <div class="logo">
        <img src="./homelogo.png" alt="Eng Pag Logo" />
      </div>
      <!-- <button
        class="toggle-btn"
        onclick="toggleSidebar()"
        aria-label="Toggle Sidebar"
      >
        <i class="fas fa-chevron-left" aria-hidden="true"></i>
      </button> -->
      <a
        href="#"
        class="active"
        onclick="showSection('notifications')"
        role="button"
        aria-label="Notificações"
        title="Notificações"
      >
        <i class="fas fa-bell" aria-hidden="true"></i>
        <span>Notificações</span>
      </a>
      <div class="submenu" aria-label="Submenu de Notificações">
        <a
          href="#"
          onclick="showSubSection('sendUser')"
          role="button"
          aria-label="Enviar para Usuário"
          title="Enviar para Usuário"
        >
          <i class="fas fa-user-plus" aria-hidden="true"></i>
          <span>Enviar para Usuário</span>
        </a>
        <a
          href="#"
          onclick="showSubSection('sendAll')"
          role="button"
          aria-label="Enviar para Todos"
          title="Enviar para Todos"
        >
          <i class="fas fa-users" aria-hidden="true"></i>
          <span>Enviar para Todos</span>
        </a>
        <a
          href="#"
          onclick="showSubSection('bulkUpload')"
          role="button"
          aria-label="Upload em Massa"
          title="Upload em Massa"
        >
          <i class="fas fa-file-excel" aria-hidden="true"></i>
          <span>Enviar para uma lista</span>
        </a>
        <a
          href="#"
          onclick="showSubSection('viewByCpf')"
          role="button"
          aria-label="Visualizar por CPF"
          title="Visualizar por CPF"
        >
          <i class="fas fa-search" aria-hidden="true"></i>
          <span>Visualizar por CPF</span>
        </a>
      </div>
      <a
        href="#"
        onclick="logout()"
        role="button"
        aria-label="Sair"
        title="Sair"
      >
        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
        <span>Sair</span>
      </a>
    </div>

    <!-- Conteúdo Principal -->
    <div
      class="main-content"
      id="mainContent"
      aria-label="Conteúdo Principal"
      style="display: none"
    >
      <div class="container">
        <h1>Gerenciador - Eng Pag</h1>

        <!-- Seção de Notificações -->
        <div id="notificationsSection" class="section">
          <!-- Subseção: Enviar Mensagem para Usuário -->
          <div id="sendUserSection">
            <h2>Enviar Mensagem para Usuário</h2>
            <label for="cpf">CPF do Usuário:</label>
            <input
              type="text"
              id="cpf"
              placeholder="Ex: 12345678901"
              aria-label="CPF do Usuário"
            />

            <label for="userSubject">Assunto:</label>
            <input
              type="text"
              id="userSubject"
              placeholder="Assunto da mensagem"
              aria-label="Assunto da Mensagem"
            />

            <label for="userMessage">Mensagem:</label>
            <textarea
              id="userMessage"
              placeholder="Escreva sua mensagem..."
              aria-label="Mensagem"
            ></textarea>

            <div class="checkbox-container">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  id="userShowOnLogin"
                  name="showOnLogin"
                />
                <span>Mostrar esta mensagem no login do usuário</span>
              </label>
            </div>

            <button onclick="sendMessageToUser()" aria-label="Enviar Mensagem">
              <i class="fas fa-paper-plane" aria-hidden="true" style="padding-right: 10px;"></i> Enviar
              Mensagem
              <div
                id="sendUserSpinner"
                class="spinner"
                style="display: none"
                aria-hidden="true"
              ></div>
            </button>

            <div id="userFeedback" role="alert" aria-live="polite"></div>
          </div>

          <!-- Subseção: Enviar Mensagem para Todos Usuários -->
          <div id="sendAllSection" style="display: none">
            <h2>Enviar Mensagem para Todos Usuários</h2>

            <label for="allUsersSubject">Assunto:</label>
            <input
              type="text"
              id="allUsersSubject"
              placeholder="Assunto da mensagem"
              aria-label="Assunto da Mensagem"
            />

            <label for="allUsersMessage">Mensagem:</label>
            <textarea
              id="allUsersMessage"
              placeholder="Escreva sua mensagem para todos..."
              aria-label="Mensagem para Todos"
            ></textarea>

            <div class="checkbox-container">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  id="allUsersShowOnLogin"
                  name="showOnLogin"
                />
                <span>Mostrar esta mensagem no login dos usuários</span>
              </label>
            </div>

            <button
              onclick="sendMessageToAll()"
              aria-label="Enviar Mensagem para Todos"
            >
              <i class="fas fa-paper-plane" aria-hidden="true" style="padding-right: 10px;"></i> Enviar
              Mensagem para Todos
              <div
                id="sendAllSpinner"
                class="spinner"
                style="display: none"
                aria-hidden="true"
              ></div>
            </button>

            <div id="allUsersFeedback" role="alert" aria-live="polite"></div>
          </div>

          <div id="bulkUploadSection" style="display: none">
            <h2>Upload em Massa de Mensagens</h2>

            <div class="excel-instructions">
              <h3>Instruções:</h3>
              <p>A planilha deve conter as seguintes colunas:</p>
              <ul>
                <li>CPF: CPF do usuário</li>
                <li>Assunto: Assunto da mensagem</li>
                <li>Mensagem: Conteúdo da mensagem</li>
                <li>
                  Mostrarnologin: Coloque "sim" ou "não" para informar se a mensagem deve aparecer
                  no login, "Mostrarnologin" precisa ser junto.
                </li>
              </ul>
            </div>

            <form id="bulkUploadForm" class="upload-form">
              <div class="file-input-container">
                <label for="excelFile">Selecione a planilha Excel:</label>
                <input
                  type="file"
                  id="excelFile"
                  accept=".xlsx,.xls"
                  aria-label="Arquivo Excel"
                />
              </div>

              <div
                id="previewContainer"
                style="display: none"
                class="preview-container"
              >
                <h3>Preview dos Dados</h3>
                <div class="preview-controls">
                  <button
                    type="button"
                    id="selectAllBtn"
                    class="secondary-button"
                  >
                    Selecionar Todos
                  </button>
                  <button
                    type="button"
                    id="deselectAllBtn"
                    class="secondary-button"
                  >
                    Desselecionar Todos
                  </button>
                </div>
                <div id="previewTable" class="preview-table"></div>
              </div>

              <button
                type="submit"
                id="sendButton"
                style="display: none"
                aria-label="Enviar Mensagens"
              >
                <i class="fas fa-paper-plane" aria-hidden="true"></i> Enviar
                Mensagens
                <div
                  id="bulkUploadSpinner"
                  class="spinner"
                  style="display: none"
                  aria-hidden="true"
                ></div>
              </button>
            </form>

            <div id="bulkUploadFeedback" role="alert" aria-live="polite"></div>
            <div id="uploadResults"></div>
          </div>
          <!-- Subseção: Visualizar Notificações por CPF -->
          <div id="viewByCpfSection" style="display: none">
            <h2>Visualizar Notificações por CPF</h2>
            <label for="viewCpf">CPF do Usuário:</label>
            <input
              type="text"
              id="viewCpf"
              placeholder="Ex: 12345678901"
              aria-label="CPF do Usuário"
            />
            <button
              onclick="viewNotificationsByCpf()"
              aria-label="Visualizar Notificações"
            >
              <i class="fas fa-search" aria-hidden="true" style="padding-right: 10px;"></i> Visualizar
              Notificações
              <div
                id="viewCpfSpinner"
                class="spinner"
                style="display: none"
                aria-hidden="true"
              ></div>
            </button>

            <div id="notificationsList"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // URL do seu backend
      const backendUrl = "https://engpag.backend.gustavohenrique.dev";

      // Elementos de login
      const loginContainer = document.getElementById("loginContainer");
      const mainContent = document.getElementById("mainContent");
      const sidebar = document.getElementById("sidebar");
      const loginForm = document.getElementById("loginForm");
      const loginFeedback = document.getElementById("loginFeedback");

      // Variáveis globais para o processamento do Excel
      let processedData = [];

      // Verificar se o usuário está logado
      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        if (token) {
          loginContainer.style.display = "none";
          mainContent.style.display = "block";
          sidebar.style.display = "flex";
          showSection("notifications");
          showSubSection("sendUser");
        } else {
          loginContainer.style.display = "flex";
          mainContent.style.display = "none";
          sidebar.style.display = "none";
        }
      });

      // Função de login
      loginForm.addEventListener("submit", async function (event) {
        event.preventDefault();

        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();

        loginFeedback.innerHTML = "";

        if (username === "" || password === "") {
          loginFeedback.innerHTML =
            '<div class="message error">Por favor, preencha o usuário e a senha.</div>';
          return;
        }

        loginFeedback.innerHTML =
          '<div class="message success">Autenticando...</div>';

        try {
          const response = await fetch(`${backendUrl}/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ login: username, senha: password }),
          });

          if (!response.ok) {
            if (response.status === 404) {
              loginFeedback.innerHTML =
                '<div class="message error">Serviço não encontrado. Verifique a URL do servidor.</div>';
            } else if (response.status === 502) {
              loginFeedback.innerHTML =
                '<div class="message error">Erro de conexão com o servidor. Tente novamente mais tarde.</div>';
            } else {
              const errorData = await response.json();
              loginFeedback.innerHTML = `<div class="message error">${
                errorData.mensagem || "Erro no login."
              }</div>`;
            }
          } else {
            const data = await response.json();
            localStorage.setItem("token", data.token);
            loginFeedback.innerHTML =
              '<div class="message success">Login bem-sucedido! Redirecionando...</div>';

            setTimeout(() => {
              loginContainer.style.display = "none";
              mainContent.style.display = "block";
              sidebar.style.display = "flex";
              showSection("notifications");
              showSubSection("sendUser");
            }, 1000);
          }
        } catch (error) {
          console.error("Erro ao realizar login:", error);
          if (error.message.includes("Failed to fetch")) {
            loginFeedback.innerHTML =
              '<div class="message error">Erro de conexão. Verifique sua rede ou permissões CORS.</div>';
          } else {
            loginFeedback.innerHTML =
              '<div class="message error">Erro ao realizar login. Tente novamente mais tarde.</div>';
          }
        }
      });

      function logout() {
        localStorage.removeItem("token");
        window.location.reload();
      }

      function getAuthHeaders() {
        const token = localStorage.getItem("token");
        return token ? { Authorization: `Bearer ${token}` } : {};
      }

      function toggleSidebar() {
        const toggleBtnIcon = sidebar.querySelector(".toggle-btn i");
        sidebar.classList.toggle("collapsed");

        if (sidebar.classList.contains("collapsed")) {
          toggleBtnIcon.classList.remove("fa-chevron-left");
          toggleBtnIcon.classList.add("fa-chevron-right");

          const sidebarLinks = sidebar.querySelectorAll("a");
          sidebarLinks.forEach((link) => {
            link.classList.add("collapsed-tooltip");
            link.setAttribute(
              "data-tooltip",
              link.querySelector("span").textContent.trim()
            );
          });
        } else {
          toggleBtnIcon.classList.remove("fa-chevron-right");
          toggleBtnIcon.classList.add("fa-chevron-left");

          const sidebarLinks = sidebar.querySelectorAll("a");
          sidebarLinks.forEach((link) => {
            link.classList.remove("collapsed-tooltip");
            link.removeAttribute("data-tooltip");
          });
        }
      }

      function showSection(section) {
        const notificationsSection = document.getElementById(
          "notificationsSection"
        );
        const sidebarLinks = document.querySelectorAll(".sidebar a");

        sidebarLinks.forEach((link) => {
          link.classList.remove("active");
        });

        if (section === "notifications") {
          notificationsSection.style.display = "block";
          sidebarLinks.forEach((link) => {
            if (link.textContent.trim() === "Notificações") {
              link.classList.add("active");
            }
          });
          toggleSubmenu("Notificações");
        }
      }

      function showSubSection(subSection) {
        const sendUserSection = document.getElementById("sendUserSection");
        const sendAllSection = document.getElementById("sendAllSection");
        const viewByCpfSection = document.getElementById("viewByCpfSection");
        const bulkUploadSection = document.getElementById("bulkUploadSection");
        const submenuLinks = document.querySelectorAll(".submenu a");

        submenuLinks.forEach((link) => {
          link.classList.remove("active-sub");
        });

        sendUserSection.style.display = "none";
        sendAllSection.style.display = "none";
        viewByCpfSection.style.display = "none";
        bulkUploadSection.style.display = "none";

        if (subSection === "sendUser") {
          sendUserSection.style.display = "block";
          submenuLinks.forEach((link) => {
            if (link.textContent.trim() === "Enviar para Usuário") {
              link.classList.add("active-sub");
            }
          });
        } else if (subSection === "sendAll") {
          sendAllSection.style.display = "block";
          submenuLinks.forEach((link) => {
            if (link.textContent.trim() === "Enviar para Todos") {
              link.classList.add("active-sub");
            }
          });
        } else if (subSection === "viewByCpf") {
          viewByCpfSection.style.display = "block";
          submenuLinks.forEach((link) => {
            if (link.textContent.trim() === "Visualizar por CPF") {
              link.classList.add("active-sub");
            }
          });
        } else if (subSection === "bulkUpload") {
          bulkUploadSection.style.display = "block";
          submenuLinks.forEach((link) => {
            if (link.textContent.trim() === "Upload em Massa") {
              link.classList.add("active-sub");
            }
          });
        }
      }

      function toggleSubmenu(menuName) {
        const submenu = document.querySelector(".sidebar .submenu");
        const parentLink = Array.from(
          document.querySelectorAll(".sidebar a")
        ).find((link) => link.textContent.trim() === menuName);

        if (submenu.style.display === "flex") {
          submenu.style.display = "none";
          parentLink.classList.remove("active");
        } else {
          submenu.style.display = "flex";
          parentLink.classList.add("active");
        }
      }

      function hideSubmenu() {
        const submenu = document.querySelector(".sidebar .submenu");
        const parentLink = Array.from(
          document.querySelectorAll(".sidebar a")
        ).find((link) => link.textContent.trim() === "Notificações");
        submenu.style.display = "none";
        parentLink.classList.remove("active");
      }

      // Funções para Excel
      function validateCPF(cpf) {
        cpf = cpf.toString().replace(/\D/g, "");
        return cpf.length === 11;
      }

      function validateRow(row) {
        const errors = [];

        if (!row.cpf || !validateCPF(row.cpf)) {
          errors.push("CPF inválido");
        }
        if (!row.subject?.trim()) {
          errors.push("Assunto é obrigatório");
        }
        if (!row.message?.trim()) {
          errors.push("Mensagem é obrigatória");
        }

        return errors;
      }

      function processExcelFile(file) {
        const reader = new FileReader();

        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            processedData = jsonData.map((row) => {
              // Mapear campos do português para inglês
              const processed = {
                cpf: String(row.CPF || "").replace(/\D/g, ""),
                subject: row.Assunto || "", // campo em português
                message: row.Mensagem || "", // campo em português
                showOnHome: row.Mostrarnologin?.toLowerCase() === "sim", // campo em português
                selected: true,
                errors: [],
              };

              // Validar dados
              if (!processed.cpf || !validateCPF(processed.cpf)) {
                processed.errors.push("CPF inválido");
              }
              if (!processed.subject) {
                processed.errors.push("Assunto é obrigatório");
              }
              if (!processed.message) {
                processed.errors.push("Mensagem é obrigatória");
              }

              return processed;
            });

            displayPreview(processedData);
          } catch (error) {
            console.error("Erro ao processar arquivo:", error);
            document.getElementById("bulkUploadFeedback").innerHTML =
              '<div class="message error">Erro ao processar o arquivo. Verifique se o formato está correto.</div>';
          }
        };

        reader.readAsArrayBuffer(file);
      }

      // Atualize também a função displayPreview para mostrar os rótulos em português
      function displayPreview(data) {
        const previewContainer = document.getElementById("previewContainer");
        const previewTable = document.getElementById("previewTable");
        const sendButton = document.getElementById("sendButton");

        let html = `
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" checked></th>
          <th>CPF</th>
          <th>Assunto</th>
          <th>Mensagem</th>
          <th>Mostrar no Login</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
  `;

        data.forEach((row, index) => {
          const isInvalid = row.errors.length > 0;
          html += `
      <tr class="${isInvalid ? "invalid-row" : ""}">
        <td>
          <input type="checkbox" class="row-checkbox" data-index="${index}" 
            ${row.selected ? "checked" : ""} ${isInvalid ? "disabled" : ""}>
        </td>
        <td>${row.cpf}</td>
        <td>${row.subject}</td>
        <td>${row.message}</td>
        <td>${row.showOnHome ? "sim" : "não"}</td>
        <td>
          ${
            isInvalid
              ? `<div class="error-message">${row.errors.join(", ")}</div>`
              : '<span class="status-success">Válido</span>'
          }
        </td>
      </tr>
    `;
        });

        html += "</tbody></table>";

        previewTable.innerHTML = html;
        previewContainer.style.display = "block";
        sendButton.style.display = "block";

        // Event Listeners
        document
          .getElementById("selectAll")
          .addEventListener("change", function (e) {
            const checkboxes = document.querySelectorAll(
              ".row-checkbox:not([disabled])"
            );
            checkboxes.forEach((cb) => {
              cb.checked = e.target.checked;
              processedData[cb.dataset.index].selected = e.target.checked;
            });
          });

        document.querySelectorAll(".row-checkbox").forEach((checkbox) => {
          checkbox.addEventListener("change", function (e) {
            processedData[e.target.dataset.index].selected = e.target.checked;
          });
        });
      }

      async function sendMessageToUser() {
        const cpf = document.getElementById("cpf").value.trim();
        const subject = document.getElementById("userSubject").value.trim();
        const message = document.getElementById("userMessage").value.trim();
        const showOnLogin = document.getElementById("userShowOnLogin").checked;
        const feedback = document.getElementById("userFeedback");
        const spinner = document.getElementById("sendUserSpinner");

        feedback.innerHTML = "";

        if (cpf === "" || subject === "" || message === "") {
          feedback.innerHTML =
            '<div class="message error">Por favor, preencha o CPF, assunto e a mensagem.</div>';
          return;
        }

        spinner.style.display = "block";

        try {
          const response = await fetch(`${backendUrl}/send-message`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            },
            body: JSON.stringify({
              cpf,
              subject,
              message,
              showOnHome: showOnLogin,
            }),
          });

          if (response.ok) {
            const result = await response.text();
            feedback.innerHTML = `<div class="message success">${result}</div>`;
            document.getElementById("cpf").value = "";
            document.getElementById("userSubject").value = "";
            document.getElementById("userMessage").value = "";
            document.getElementById("userShowOnLogin").checked = false;
          } else {
            const errorText = await response.text();
            feedback.innerHTML = `<div class="message error">Erro: ${errorText}</div>`;
          }
        } catch (error) {
          console.error("Erro ao enviar mensagem:", error);
          feedback.innerHTML =
            '<div class="message error">Erro ao enviar mensagem.</div>';
        } finally {
          spinner.style.display = "none";
        }
      }

      async function sendMessageToAll() {
        const subject = document.getElementById("allUsersSubject").value.trim();
        const message = document.getElementById("allUsersMessage").value.trim();
        const showOnLogin = document.getElementById(
          "allUsersShowOnLogin"
        ).checked;
        const feedback = document.getElementById("allUsersFeedback");
        const spinner = document.getElementById("sendAllSpinner");

        feedback.innerHTML = "";

        if (subject === "" || message === "") {
          feedback.innerHTML =
            '<div class="message error">Por favor, preencha o assunto e a mensagem.</div>';
          return;
        }

        spinner.style.display = "block";

        try {
          const response = await fetch(`${backendUrl}/send-message-all`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            },
            body: JSON.stringify({ subject, message, showOnHome: showOnLogin }),
          });

          if (response.ok) {
            const result = await response.text();
            feedback.innerHTML = `<div class="message success">${result}</div>`;
            document.getElementById("allUsersSubject").value = "";
            document.getElementById("allUsersMessage").value = "";
            document.getElementById("allUsersShowOnLogin").checked = false;
          } else {
            const errorText = await response.text();
            feedback.innerHTML = `<div class="message error">Erro: ${errorText}</div>`;
          }
        } catch (error) {
          console.error("Erro ao enviar mensagem para todos:", error);
          feedback.innerHTML =
            '<div class="message error">Erro ao enviar mensagem para todos.</div>';
        } finally {
          spinner.style.display = "none";
        }
      }

      function generateNotificationsTable(notifications) {
  let html = `
    <table>
      <thead>
        <tr>
          <th class="date-column">Data</th>
          <th class="subject-column">Assunto</th>
          <th class="message-column">Mensagem</th>
          <th class="status-column">Mostrar no Login</th>
          <th class="actions-column">Ações</th>
        </tr>
      </thead>
      <tbody>
  `;

  notifications.forEach(notification => {
    const date = notification.dateSent ? 
      new Date(notification.dateSent).toLocaleDateString("pt-BR") : "";

    html += `
      <tr id="notification-${notification._id}">
        <td class="date-column">${date}</td>
        <td class="subject-column" id="subject-${notification._id}">${notification.subject || ""}</td>
        <td class="message-column" id="message-${notification._id}">${notification.message || ""}</td>
        <td class="status-column">
          <span class="show-on-login-status ${notification.showOnHome ? "active" : ""}">
            ${notification.showOnHome ? "Sim" : "Não"}
          </span>
        </td>
        <td class="actions-column">
          <button class="action-btn edit-btn" onclick="editNotification('${notification._id}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn delete-btn" onclick="deleteNotification('${notification._id}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `;
  });

  html += `
      </tbody>
    </table>
  `;

  return html;
}
async function viewNotificationsByCpf() {
  const cpf = document.getElementById("viewCpf").value.trim();
  const notificationsList = document.getElementById("notificationsList");
  const spinner = document.getElementById("viewCpfSpinner");
  
  try {
    if (!cpf) {
      notificationsList.innerHTML = '<div class="message error">Por favor, preencha o CPF.</div>';
      return;
    }

    spinner.style.display = "block";
    const token = localStorage.getItem("token");
    
    if (!token) {
      notificationsList.innerHTML = '<div class="message error">Sessão expirada. Por favor, faça login novamente.</div>';
      return;
    }

    const response = await fetch(
      `${backendUrl}/notifications?cpf=${encodeURIComponent(cpf)}`,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );

    if (!response.ok) {
      if (response.status === 401) {
        localStorage.removeItem("token");
        window.location.reload();
        return;
      }
      const errorText = await response.text();
      throw new Error(errorText || `HTTP error! status: ${response.status}`);
    }

    const notifications = await response.json();

    if (!notifications || notifications.length === 0) {
      notificationsList.innerHTML = '<div class="message info">Nenhuma notificação encontrada para este CPF.</div>';
      return;
    }

    notificationsList.innerHTML = generateNotificationsTable(notifications);

  } catch (error) {
    console.error("Erro ao buscar notificações:", error);
    notificationsList.innerHTML = `<div class="message error">Erro ao buscar notificações: ${error.message}</div>`;
  } finally {
    spinner.style.display = "none";
  }
}
      function editNotification(id) {
        const subjectElement = document.getElementById(`subject-${id}`);
        const messageElement = document.getElementById(`message-${id}`);

        const currentSubject = subjectElement.textContent;
        const currentMessage = messageElement.textContent;

        subjectElement.innerHTML = `<input type="text" id="edit-subject-${id}" value="${currentSubject}" />`;
        messageElement.innerHTML = `<textarea id="edit-message-${id}">${currentMessage}</textarea>`;

        const actionsCell = document.querySelector(
          `#notification-${id} .actions`
        );
        actionsCell.innerHTML = `
    <button class="action-btn save-btn" onclick="saveEditNotification('${id}')">
      <i class="fas fa-save" aria-hidden="true"></i>
    </button>
    <button class="action-btn cancel-btn" onclick="cancelEditNotification('${id}', '${currentSubject.replace(
          /'/g,
          "\\'"
        )}', '${currentMessage.replace(/'/g, "\\'")}')">
      <i class="fas fa-times" aria-hidden="true"></i>
    </button>
  `;
      }

      async function saveEditNotification(id) {
        const newSubject = document
          .getElementById(`edit-subject-${id}`)
          .value.trim();
        const newMessage = document
          .getElementById(`edit-message-${id}`)
          .value.trim();

        if (newSubject === "" || newMessage === "") {
          alert("Assunto e mensagem não podem estar vazios.");
          return;
        }

        try {
          const response = await fetch(`${backendUrl}/notifications/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            },
            body: JSON.stringify({ subject: newSubject, message: newMessage }),
          });

          if (response.ok) {
            const updatedNotification = await response.json();
            document.getElementById(`subject-${id}`).textContent =
              updatedNotification.subject;
            document.getElementById(`message-${id}`).textContent =
              updatedNotification.message;

            const actionsCell = document.querySelector(
              `#notification-${id} .actions`
            );
            actionsCell.innerHTML = `
        <button class="action-btn edit-btn" onclick="editNotification('${id}')">
          <i class="fas fa-edit" aria-hidden="true"></i>
        </button>
        <button class="action-btn delete-btn" onclick="deleteNotification('${id}')">
          <i class="fas fa-trash" aria-hidden="true"></i>
        </button>
      `;

            alert("Notificação atualizada com sucesso");
          } else {
            const errorText = await response.text();
            alert(`Erro ao editar notificação: ${errorText}`);
          }
        } catch (error) {
          console.error("Erro ao editar notificação:", error);
          alert("Erro ao editar notificação.");
        }
      }

      function cancelEditNotification(id, originalSubject, originalMessage) {
        document.getElementById(`subject-${id}`).textContent = originalSubject;
        document.getElementById(`message-${id}`).textContent = originalMessage;

        const actionsCell = document.querySelector(
          `#notification-${id} .actions`
        );
        actionsCell.innerHTML = `
    <button class="action-btn edit-btn" onclick="editNotification('${id}')">
      <i class="fas fa-edit" aria-hidden="true"></i>
    </button>
    <button class="action-btn delete-btn" onclick="deleteNotification('${id}')">
      <i class="fas fa-trash" aria-hidden="true"></i>
    </button>
  `;
      }

      async function deleteNotification(id) {
        if (!confirm("Tem certeza de que deseja deletar esta notificação?")) {
          return;
        }

        try {
          const response = await fetch(`${backendUrl}/notifications/${id}`, {
            method: "DELETE",
            headers: {
              ...getAuthHeaders(),
            },
          });

          if (response.ok) {
            const row = document.getElementById(`notification-${id}`);
            if (row) {
              row.remove();
            }
            alert("Notificação deletada com sucesso");
          } else {
            const errorText = await response.text();
            alert(`Erro ao deletar notificação: ${errorText}`);
          }
        } catch (error) {
          console.error("Erro ao deletar notificação:", error);
          alert("Erro ao deletar notificação.");
        }
      }

      // Event Listeners para o Excel
      document
        .getElementById("excelFile")
        ?.addEventListener("change", function (e) {
          if (e.target.files.length) {
            processExcelFile(e.target.files[0]);
          }
        });

      document
        .getElementById("selectAllBtn")
        ?.addEventListener("click", function () {
          document.getElementById("selectAll").checked = true;
          document
            .querySelectorAll(".row-checkbox:not([disabled])")
            .forEach((cb) => {
              cb.checked = true;
              processedData[cb.dataset.index].selected = true;
            });
        });

      document
        .getElementById("deselectAllBtn")
        ?.addEventListener("click", function () {
          document.getElementById("selectAll").checked = false;
          document
            .querySelectorAll(".row-checkbox:not([disabled])")
            .forEach((cb) => {
              cb.checked = false;
              processedData[cb.dataset.index].selected = false;
            });
        });

      document
        .getElementById("bulkUploadForm")
        ?.addEventListener("submit", async function (e) {
          e.preventDefault();

          const feedback = document.getElementById("bulkUploadFeedback");
          const spinner = document.getElementById("bulkUploadSpinner");
          const selectedData = processedData.filter(
            (row) => row.selected && row.errors.length === 0
          );

          if (selectedData.length === 0) {
            feedback.innerHTML =
              '<div class="message error">Nenhum registro válido selecionado para envio.</div>';
            return;
          }

          spinner.style.display = "block";
          feedback.innerHTML =
            '<div class="message">Enviando mensagens...</div>';

          try {
            const results = { success: [], failed: [] };

            for (let i = 0; i < selectedData.length; i += 5) {
              const batch = selectedData.slice(i, i + 5);

              const promises = batch.map((data) =>
                fetch(`${backendUrl}/send-message`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    ...getAuthHeaders(),
                  },
                  body: JSON.stringify({
                    cpf: data.cpf,
                    subject: data.subject,
                    message: data.message,
                    showOnHome: data.showOnHome,
                  }),
                })
                  .then(async (response) => {
                    if (response.ok) {
                      results.success.push(data.cpf);
                    } else {
                      const error = await response.text();
                      results.failed.push({ cpf: data.cpf, error });
                    }
                  })
                  .catch((error) => {
                    results.failed.push({
                      cpf: data.cpf,
                      error: error.message,
                    });
                  })
              );

              await Promise.all(promises);
            }

            displayResults(results);
            feedback.innerHTML =
              '<div class="message success">Processamento concluído!</div>';
          } catch (error) {
            console.error("Erro no envio:", error);
            feedback.innerHTML =
              '<div class="message error">Erro ao enviar mensagens.</div>';
          } finally {
            spinner.style.display = "none";
          }
        });

      function displayResults(results) {
        const resultsDiv = document.getElementById("uploadResults");

        let html = `
    <h3>Resumo do Processamento</h3>
    <p>Mensagens enviadas com sucesso: ${results.success.length}</p>
    <p>Falhas no envio: ${results.failed.length}</p>
  `;

        if (results.failed.length > 0) {
          html += `
      <h4>Detalhes das Falhas:</h4>
      <table>
        <tr>
          <th>CPF</th>
          <th>Erro</th>
        </tr>
        ${results.failed
          .map(
            (fail) => `
          <tr>
            <td>${fail.cpf}</td>
            <td>${fail.error}</td>
          </tr>
        `
          )
          .join("")}
      </table>
    `;
        }

        resultsDiv.innerHTML = html;
      }

      // Acessibilidade: Navegação via teclado
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape" && sidebar.classList.contains("collapsed")) {
          toggleSidebar();
        }
      });
    </script>
  </body>
</html>
